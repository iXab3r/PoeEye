<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="http://metro.mahapps.com/winfx/xaml/controls"
                    xmlns:componentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
                    xmlns:viewModels="clr-namespace:PoeEye.PoeTrade.ViewModels">
  <DataTemplate DataType="{x:Type viewModels:MainWindowTabViewModel}" >
    <Grid>
      <Grid.Resources>
        <CollectionViewSource x:Key='tradesListSource'
                              Source="{Binding TradesList.Items}"
                              IsLiveFilteringRequested="True"
                              IsLiveSortingRequested="True">
          <CollectionViewSource.SortDescriptions>
            <componentModel:SortDescription PropertyName="TradeState" Direction="Ascending" />
            <componentModel:SortDescription PropertyName="RawPriceInChaosOrbs" Direction="Ascending" />
          </CollectionViewSource.SortDescriptions>

        </CollectionViewSource>
      </Grid.Resources>

      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <ScrollViewer VerticalScrollBarVisibility="Visible"
                    IsTabStop="False"
                    Focusable="False"
                    MaxHeight="{Binding ActualHeight, RelativeSource={RelativeSource FindAncestor, AncestorType=ContentPresenter}, Mode=OneWay}">
        <Expander IsExpanded="{Binding Query.IsExpanded}" Margin="0">
          <Expander.Header>
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Grid.Column="0"
                         Text="Query parameters" Margin="5,0" VerticalAlignment="Center" />
              <Button Grid.Column="1"
                      Content="Mark All as Read" Command="{Binding MarkAllAsReadCommand}" />
              
              <ContentControl Grid.Column="3" 
                              Content="{Binding ApiSelector}" MinWidth="200" HorizontalAlignment="Right" />
            </Grid>
          </Expander.Header>

          <Grid>
            <StackPanel Orientation="Vertical"
                        IsEnabled="{Binding Path=ApiSelector.SelectedModule.IsAvailable, TargetNullValue=False}">
              <controls:MetroContentControl Content="{Binding Query}" />
              
              <DockPanel>
                <Button DockPanel.Dock="Left" HorizontalAlignment="Left" Width="150" Command="{Binding ResetCommand}"
                        Content="Reset" />
                <Button DockPanel.Dock="Right" HorizontalAlignment="Right" Width="150" Command="{Binding NewSearchCommand}"
                        IsDefault="True"
                        CommandParameter="{Binding Query.PoeQueryBuilder}"
                        Content="Search" />
              </DockPanel>
            </StackPanel>
            <Border Background="{StaticResource MetroDataGrid.DisabledHighlightBrush}" Opacity="0.9">
              <Border.Visibility>
                <Binding Path="ApiSelector.SelectedModule.IsAvailable" 
                         Converter="{StaticResource TrueToCollapsedFalseToVisibleConverter}"
                         TargetNullValue="{x:Static Visibility.Visible}" />
              </Border.Visibility>
              <TextBlock 
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                TextAlignment="Center"
                Text="Selected module is not available yet, please wait for a few seconds" 
                Foreground="{StaticResource PoeFontBrush}"
                FontSize="30">
              </TextBlock>
            </Border>
          </Grid>
          
        </Expander>
      </ScrollViewer>

      <Expander Grid.Row="1"
                IsExpanded="{Binding TradesList.HistoricalTrades.IsExpanded}"
                Visibility="{Binding TradesList.HistoricalTrades.ItemsViewModels.Count, Converter={StaticResource ZeroToCollapsedConverter}}">
        <Expander.Header>
          <TextBlock>
            <Run Text="Trades history ( " />
            <Run ToolTip="Historical trades"
                 Text="{Binding TradesList.HistoricalTrades.ItemsViewModels.Count, Mode=OneWay, StringFormat=\{0\}}"
                 FontWeight="Bold" />
            <Run Text=" )" />
          </TextBlock>
        </Expander.Header>
        <ContentControl Content="{Binding TradesList.HistoricalTrades}" Margin="0" />
      </Expander>

      <Grid Grid.Row="2">

        <ItemsControl Margin="0,10,0,0"
                      ItemsSource="{Binding Source={StaticResource tradesListSource}}"
                      Style="{StaticResource VirtualizedItemsControlStyle}">
        </ItemsControl>
      </Grid>
    </Grid>
  </DataTemplate>
</ResourceDictionary>